name: Auto Merge PRs

on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 6ì‹œ KST (UTC 09:00)ì— ì‹¤í–‰
    - cron: '0 9 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Auto merge all open PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            
            console.log(`ðŸ” Fetching open PRs for ${owner}/${repo}...`);
            
            // ëª¨ë“  ì—´ë ¤ìžˆëŠ” PR ê°€ì ¸ì˜¤ê¸°
            const { data: pullRequests } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              sort: 'created',
              direction: 'asc'
            });
            
            if (pullRequests.length === 0) {
              console.log('âœ… No open PRs to merge.');
              return;
            }
            
            console.log(`ðŸ“‹ Found ${pullRequests.length} open PR(s).`);
            
            const results = {
              success: [],
              failed: []
            };
            
            for (const pr of pullRequests) {
              console.log(`\nðŸ”„ Processing PR #${pr.number}: ${pr.title}`);
              
              try {
                // PR ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                let { data: prDetails } = await github.rest.pulls.get({
                  owner,
                  repo,
                  pull_number: pr.number
                });
                
                // Draft PRì¸ ê²½ìš° Ready for Review ìƒíƒœë¡œ ë³€ê²½
                if (prDetails.draft) {
                  console.log(`ðŸ“ PR #${pr.number} is a draft. Converting to ready for review...`);
                  
                  try {
                    // GraphQL mutationì„ ì‚¬ìš©í•˜ì—¬ draft ìƒíƒœ í•´ì œ
                    await github.graphql(`
                      mutation($pullRequestId: ID!) {
                        markPullRequestReadyForReview(input: { pullRequestId: $pullRequestId }) {
                          pullRequest {
                            isDraft
                          }
                        }
                      }
                    `, {
                      pullRequestId: prDetails.node_id
                    });
                    
                    console.log(`âœ… PR #${pr.number} is now ready for review.`);
                    
                    // ìƒíƒœ ë³€ê²½ í›„ ìž ì‹œ ëŒ€ê¸° (GitHubê°€ mergeable ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•  ì‹œê°„)
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    // PR ì •ë³´ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
                    const updatedPr = await github.rest.pulls.get({
                      owner,
                      repo,
                      pull_number: pr.number
                    });
                    prDetails = updatedPr.data;
                    
                  } catch (draftError) {
                    console.log(`âš ï¸ Failed to convert draft PR #${pr.number}: ${draftError.message}`);
                    results.failed.push({
                      number: pr.number,
                      title: pr.title,
                      reason: `Failed to convert from draft: ${draftError.message}`
                    });
                    continue;
                  }
                }
                
                // PRì´ ë¨¸ì§€ ê°€ëŠ¥í•œì§€ í™•ì¸
                if (!prDetails.mergeable) {
                  console.log(`âš ï¸ PR #${pr.number} is not mergeable (conflicts or pending checks).`);
                  results.failed.push({
                    number: pr.number,
                    title: pr.title,
                    reason: 'Not mergeable (conflicts or pending checks)'
                  });
                  continue;
                }
                
                // PR ë¨¸ì§€ ì‹¤í–‰
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: pr.number,
                  merge_method: 'merge' // 'merge', 'squash', 'rebase' ì¤‘ ì„ íƒ
                });
                
                console.log(`âœ… Successfully merged PR #${pr.number}`);
                results.success.push({
                  number: pr.number,
                  title: pr.title
                });
                
              } catch (error) {
                console.log(`âŒ Failed to merge PR #${pr.number}: ${error.message}`);
                results.failed.push({
                  number: pr.number,
                  title: pr.title,
                  reason: error.message
                });
              }
            }
            
            // ê²°ê³¼ ìš”ì•½ ì¶œë ¥
            console.log('\nðŸ“Š === MERGE SUMMARY ===');
            console.log(`âœ… Successfully merged: ${results.success.length}`);
            results.success.forEach(pr => {
              console.log(`   - PR #${pr.number}: ${pr.title}`);
            });
            
            if (results.failed.length > 0) {
              console.log(`âŒ Failed to merge: ${results.failed.length}`);
              results.failed.forEach(pr => {
                console.log(`   - PR #${pr.number}: ${pr.title}`);
                console.log(`     Reason: ${pr.reason}`);
              });
            }
